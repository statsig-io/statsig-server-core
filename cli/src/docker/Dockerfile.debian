FROM debian:10-slim

RUN echo "deb http://archive.debian.org/debian/ buster main" > /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian-security/ buster/updates main" >> /etc/apt/sources.list && \
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until


RUN apt-get update
RUN apt-get install -y \
    # Common Deps
    bash curl zsh default-jre jq pkg-config libssl-dev clang \
    # Python Deps
    python3 python3-pip \
    # Node Deps
    zstd \
    # PHP Deps
    php php-curl php-xml composer \
    # Profiling
    heaptrack valgrind


# Python Setup
RUN pip3 install --upgrade pip setuptools wheel
RUN pip3 install maturin patchelf pytest pytest_httpserver requests typing-extensions pytest-rerunfailures

# Node Setup
RUN curl -fsSL https://deb.nodesource.com/setup_18.x -o nodesource_setup.sh
RUN bash nodesource_setup.sh && apt-get install -y nodejs
RUN npm install -g pnpm@7.32.4 typescript@5.7.3

# Rust Setup
ARG ARM_SUFFIX=-arm
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
ENV CARGO_TERM_COLOR=always
RUN rustup target add x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu
RUN curl -LsSf https://get.nexte.st/latest/linux${ARM_SUFFIX} | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin;

# Protoc Setup
ARG PROTOC_ARCH=aarch_64
RUN curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v29.3/protoc-29.3-linux-${PROTOC_ARCH}.zip && \
    unzip protoc-29.3-linux-${PROTOC_ARCH}.zip -d /usr/local && \
    rm protoc-29.3-linux-${PROTOC_ARCH}.zip;

# Go Setup
ARG GO_ARCH=arm64
RUN curl -fsSL https://go.dev/dl/go1.23.2.linux-${GO_ARCH}.tar.gz \
    | tar -C /usr/local -xz

# Add Go to PATH
ENV PATH="/usr/local/go/bin:${PATH}"

# FlameGraph (Profiling)
RUN git clone https://github.com/brendangregg/FlameGraph.git /opt/FlameGraph
ENV PATH="/opt/FlameGraph:${PATH}"

ENV CC=clang

ENTRYPOINT ["sh", "-c"]
